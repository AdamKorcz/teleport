
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="How to configure access and trust between two SSH and Kubernetes environments">
      
      
        <link rel="canonical" href="https://gravitational.com/teleport/docs/trustedclusters/">
      
      
        <meta name="author" content="Gravitational Inc">
      
      <link rel="shortcut icon" href="../img/favicon.ico">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.1.2+insiders-1.7.0">
    
    
      
        <title>Teleport Trusted Clusters - Gravitational Teleport</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.b0e00042.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.f0267088.min.css">
        
      
    
    
    
      
        
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,400,400i,700%7C&display=fallback">
        <style>body,input{font-family:"Lato",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
      <link rel="stylesheet" href="../css/version-select.css">
    
    
      
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
      <script>var palette=JSON.parse(localStorage.getItem("__palette")||"{}");if(void 0!==palette.color)for(var key in palette.color)document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#trusted-clusters" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://gravitational.com/teleport/docs" title="Gravitational Teleport" class="md-header-nav__button md-logo" aria-label="Gravitational Teleport">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      <div class="md-header-nav__ellipsis">
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            Gravitational Teleport
          </span>
        </div>
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            
              Teleport Trusted Clusters
            
          </span>
        </div>
      </div>
    </div>
    <div class="md-header-nav__options">
      
        
          
          
          
          <button class="md-header-nav__button md-icon" title="Switch to light mode" aria-label="Switch to light mode" data-md-option="palette" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 00-5 5 5 5 0 005 5h10a5 5 0 005-5 5 5 0 00-5-5m0 8a3 3 0 01-3-3 3 3 0 013-3 3 3 0 013 3 3 3 0 01-3 3z"/></svg>
          </button>
        
          
          
          
          <button class="md-header-nav__button md-icon" title="Switch to dark mode" aria-label="Switch to dark mode" data-md-option="palette" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="blue" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 10a2 2 0 012 2 2 2 0 01-2 2 2 2 0 01-2-2 2 2 0 012-2m10-3a5 5 0 015 5 5 5 0 01-5 5H7a5 5 0 01-5-5 5 5 0 015-5h10M7 9a3 3 0 00-3 3 3 3 0 003 3h10a3 3 0 003-3 3 3 0 00-3-3H7z"/></svg>
          </button>
        
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
      <div class="md-search__suggest" data-md-component="search-suggest"></div>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/gravitational/teleport/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://gravitational.com/teleport/docs" title="Gravitational Teleport" class="md-nav__button md-logo" aria-label="Gravitational Teleport">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Gravitational Teleport
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/gravitational/teleport/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  
  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">
    
    <label class="md-nav__link" for="nav-1">
      Documentation
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Documentation" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        <span class="md-nav__icon md-icon"></span>
        Documentation
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href=".." class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../installation/" class="md-nav__link">
      Installation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../quickstart/" class="md-nav__link">
      Quick Start Guide
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../user-manual/" class="md-nav__link">
      User Manual
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../admin-guide/" class="md-nav__link">
      Admin Manual
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../production/" class="md-nav__link">
      Production Guide
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../faq/" class="md-nav__link">
      FAQ
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  
  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Infrastructure Guides
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Infrastructure Guides" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon"></span>
        Infrastructure Guides
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../aws-oss-guide/" class="md-nav__link">
      AWS
    </a>
  </li>

        
          
          
          


  
  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2-2" type="checkbox" id="nav-2-2">
    
    <label class="md-nav__link" for="nav-2-2">
      AWS Terraform
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="AWS Terraform" data-md-level="2">
      <label class="md-nav__title" for="nav-2-2">
        <span class="md-nav__icon md-icon"></span>
        AWS Terraform
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../aws-terraform-guide/" class="md-nav__link">
      AWS Terraform
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../gcp-guide/" class="md-nav__link">
      GCP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../ibm-cloud-guide/" class="md-nav__link">
      IBM
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../kubernetes-ssh/" class="md-nav__link">
      Kubernetes Guide
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../openssh-teleport/" class="md-nav__link">
      OpenSSH Guide
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  
  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Teleport Enterprise
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Teleport Enterprise" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon"></span>
        Teleport Enterprise
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../enterprise/introduction/" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../enterprise/quickstart-enterprise/" class="md-nav__link">
      Quick Start Guide
    </a>
  </li>

        
          
          
          


  
  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-3" type="checkbox" id="nav-3-3">
    
    <label class="md-nav__link" for="nav-3-3">
      Single sign-on (SSO)
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Single sign-on (SSO)" data-md-level="2">
      <label class="md-nav__title" for="nav-3-3">
        <span class="md-nav__icon md-icon"></span>
        Single sign-on (SSO)
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../enterprise/sso/ssh-sso/" class="md-nav__link">
      SSO
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../enterprise/sso/ssh-azuread/" class="md-nav__link">
      Azure Active Directory (AD)
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../enterprise/sso/ssh-adfs/" class="md-nav__link">
      Active Directory (ADFS)
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../enterprise/sso/ssh-gsuite/" class="md-nav__link">
      G Suite
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../enterprise/sso/ssh-one-login/" class="md-nav__link">
      OneLogin
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../enterprise/sso/oidc/" class="md-nav__link">
      OIDC
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../enterprise/sso/ssh-okta/" class="md-nav__link">
      Okta
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../enterprise/workflow/" class="md-nav__link">
      Approval Workflow
    </a>
  </li>

        
          
          
          


  
  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-5" type="checkbox" id="nav-3-5">
    
    <label class="md-nav__link" for="nav-3-5">
      Teleport Plugins
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Teleport Plugins" data-md-level="2">
      <label class="md-nav__title" for="nav-3-5">
        <span class="md-nav__icon md-icon"></span>
        Teleport Plugins
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../enterprise/workflow/ssh-approval-jira-cloud/" class="md-nav__link">
      Teleport  Plugin Setup
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../enterprise/workflow/ssh-approval-jira-server/" class="md-nav__link">
      Teleport Jira Server Plugin Setup
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../enterprise/workflow/ssh-approval-mattermost/" class="md-nav__link">
      Teleport Mattermost Plugin Setup
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../enterprise/workflow/ssh-approval-pagerduty/" class="md-nav__link">
      Teleport Pagerduty Plugin Setup
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../enterprise/workflow/ssh-approval-slack/" class="md-nav__link">
      Teleport Slack Plugin Setup
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../enterprise/ssh-kubernetes-fedramp/" class="md-nav__link">
      FedRAMP for SSH & K8s
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../enterprise/ssh-rbac/" class="md-nav__link">
      RBAC
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  
  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      Architecture
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Architecture" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon"></span>
        Architecture
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../architecture/overview/" class="md-nav__link">
      Architecture Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../architecture/users/" class="md-nav__link">
      Teleport Users
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../architecture/nodes/" class="md-nav__link">
      Teleport Nodes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../architecture/authentication/" class="md-nav__link">
      Teleport Auth
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../architecture/proxy/" class="md-nav__link">
      Teleport Proxy
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Trusted Clusters
        <span class="md-nav__icon md-icon"></span>
      </label>
    
    <a href="./" class="md-nav__link md-nav__link--active">
      Trusted Clusters
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#join-tokens" class="md-nav__link">
    Join Tokens
  </a>
  
    <nav class="md-nav" aria-label="Join Tokens">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#static-join-tokens" class="md-nav__link">
    Static Join Tokens
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamic-join-tokens" class="md-nav__link">
    Dynamic Join Tokens
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#security-implications" class="md-nav__link">
    Security Implications
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rbac" class="md-nav__link">
    RBAC
  </a>
  
    <nav class="md-nav" aria-label="RBAC">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example" class="md-nav__link">
    Example
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#trusted-cluster-ui" class="md-nav__link">
    Trusted Cluster UI
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#updating-trusted-cluster-role-map" class="md-nav__link">
    Updating Trusted Cluster Role Map
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-trusted-clusters" class="md-nav__link">
    Using Trusted Clusters
  </a>
  
    <nav class="md-nav" aria-label="Using Trusted Clusters">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#disabling-trust" class="md-nav__link">
    Disabling Trust
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remove-leaf-cluster-relationship-from-both-sides" class="md-nav__link">
    Remove Leaf Cluster relationship from both sides
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remove-leaf-cluster-relationship-from-the-root" class="md-nav__link">
    Remove Leaf Cluster relationship from the root
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remove-leaf-cluster-relationship-from-the-leaf" class="md-nav__link">
    Remove Leaf Cluster relationship from the leaf
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sharing-kubernetes-groups-between-trusted-clusters" class="md-nav__link">
    Sharing Kubernetes groups between Trusted Clusters
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-does-it-work" class="md-nav__link">
    How does it work?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#troubleshooting" class="md-nav__link">
    Troubleshooting
  </a>
  
    <nav class="md-nav" aria-label="Troubleshooting">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#https-configuration" class="md-nav__link">
    HTTPS configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#connectivity-problems" class="md-nav__link">
    Connectivity Problems
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#access-problems" class="md-nav__link">
    Access Problems
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  
  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Advanced Features
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Advanced Features" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        <span class="md-nav__icon md-icon"></span>
        Advanced Features
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../features/enhanced-session-recording/" class="md-nav__link">
      Enhanced Session Rec.
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../features/ssh-pam/" class="md-nav__link">
      Using Teleport with PAM
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  
  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Reference
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Reference" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        <span class="md-nav__icon md-icon"></span>
        Reference
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../config-reference/" class="md-nav__link">
      YAML
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../cli-docs/" class="md-nav__link">
      CLI
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../api-reference/" class="md-nav__link">
      API
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../metrics-logs-reference/" class="md-nav__link">
      Metrics
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              
                
              
              
                <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                  <div class="md-sidebar__scrollwrap">
                    <div class="md-sidebar__inner">
                      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#join-tokens" class="md-nav__link">
    Join Tokens
  </a>
  
    <nav class="md-nav" aria-label="Join Tokens">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#static-join-tokens" class="md-nav__link">
    Static Join Tokens
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamic-join-tokens" class="md-nav__link">
    Dynamic Join Tokens
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#security-implications" class="md-nav__link">
    Security Implications
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rbac" class="md-nav__link">
    RBAC
  </a>
  
    <nav class="md-nav" aria-label="RBAC">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example" class="md-nav__link">
    Example
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#trusted-cluster-ui" class="md-nav__link">
    Trusted Cluster UI
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#updating-trusted-cluster-role-map" class="md-nav__link">
    Updating Trusted Cluster Role Map
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-trusted-clusters" class="md-nav__link">
    Using Trusted Clusters
  </a>
  
    <nav class="md-nav" aria-label="Using Trusted Clusters">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#disabling-trust" class="md-nav__link">
    Disabling Trust
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remove-leaf-cluster-relationship-from-both-sides" class="md-nav__link">
    Remove Leaf Cluster relationship from both sides
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remove-leaf-cluster-relationship-from-the-root" class="md-nav__link">
    Remove Leaf Cluster relationship from the root
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remove-leaf-cluster-relationship-from-the-leaf" class="md-nav__link">
    Remove Leaf Cluster relationship from the leaf
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sharing-kubernetes-groups-between-trusted-clusters" class="md-nav__link">
    Sharing Kubernetes groups between Trusted Clusters
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-does-it-work" class="md-nav__link">
    How does it work?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#troubleshooting" class="md-nav__link">
    Troubleshooting
  </a>
  
    <nav class="md-nav" aria-label="Troubleshooting">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#https-configuration" class="md-nav__link">
    HTTPS configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#connectivity-problems" class="md-nav__link">
    Connectivity Problems
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#access-problems" class="md-nav__link">
    Access Problems
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                    </div>
                  </div>
                </div>
              
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/gravitational/teleport/edit/master/docs/trustedclusters.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="trusted-clusters">Trusted Clusters</h1>
<p>The design of trusted clusters allows Teleport users to connect to compute infrastructure
located behind firewalls without any open TCP ports. The real world usage examples of this
capability include:</p>
<ul>
<li>Managed service providers (MSP) remotely managing infrastructure of their clients.</li>
<li>Device manufacturers remotely maintaining computing appliances deployed on premises.</li>
<li>Large cloud software vendors manage multiple data centers using a common proxy.</li>
</ul>
<p><strong>Example of a MSP provider using trusted cluster to obtain access to clients clusters.</strong>
<img alt="MSP Example" src="../img/trusted-clusters/TrustedClusters-MSP.svg" /></p>
<p>If you haven't already looked at the introduction to <a href="../admin-guide/#trusted-clusters">Trusted Clusters</a>
in the Admin Guide we recommend you review that for an overview before continuing with this guide.</p>
<p>The Trusted Clusters chapter in the Admin Guide
offers an example of a simple configuration which:</p>
<ul>
<li>Uses a static cluster join token defined in a configuration file.</li>
<li>Does not cover inter-cluster role based access control (RBAC).</li>
</ul>
<p>This guide's focus is on more in-depth coverage of trusted clusters features and will cover the following topics:</p>
<ul>
<li>How to add and remove trusted clusters using CLI commands.</li>
<li>Enable/disable trust between clusters.</li>
<li>Establish permissions mapping between clusters using Teleport roles.</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Teleport Node Tunneling</p>
<p>If you have a large amount of devices on different networks, such as
managed IoT devices or a couple of nodes on a different network you can utilize
the <a href="../admin-guide/#adding-a-node-located-behind-nat">Teleport Node Tunneling</a>.</p>
</div>
<h2 id="introduction">Introduction</h2>
<p>As explained in the <a href="../architecture/overview/#design-principles">architecture document</a>,
Teleport can partition compute infrastructure into multiple clusters.
A cluster is a group of SSH nodes connected to the cluster's <em>auth server</em>
acting as a certificate authority (CA) for all users and nodes.</p>
<p>To retrieve an SSH certificate, users must authenticate with a cluster through a
<em>proxy server</em>. So, if users want to connect to nodes belonging to different
clusters, they would normally have to use different <code>--proxy</code> flags for each
cluster. This is not always convenient.</p>
<p>The concept of <em>leaf clusters</em> allows Teleport administrators to connect
multiple clusters together and establish trust between them. Trusted clusters
allow users of one cluster, the root cluster to seamlessly SSH into the nodes of
another cluster without having to "hop" between proxy servers. Moreover, users don't
even need to have a direct connection to other clusters' proxy servers. The user
experience looks like this:</p>
<div class="highlight"><pre><span></span><code># login using the root &quot;root&quot; cluster credentials:
$ tsh login --proxy=root.example.com

# SSH into some host inside the &quot;root&quot; cluster:
$ tsh ssh host

# SSH into the host located in another cluster called &quot;leaf&quot;
# The connection is established through root.example.com:
$ tsh ssh --cluster=leaf host

# See what other clusters are available
$ tsh clusters
</code></pre></div>
<p>Leaf clusters also have their own restrictions on user access, i.e.
<em>permissions mapping</em> takes place.</p>
<p><strong>Once connection has been established it's easy to switch from the "root" root cluster</strong>
<img alt="Teleport Cluster Page" src="../img/trusted-clusters/teleport-trusted-cluster.png" /></p>
<p>Let's take a look at how a connection is established between the "root" cluster
and the "leaf" cluster:</p>
<p><img alt="Tunnels" src="../img/tunnel.svg" /></p>
<p>This setup works as follows:</p>
<ol>
<li>
<p>The "leaf" creates an outbound reverse SSH tunnel to "root" and keeps the
   tunnel open.</p>
</li>
<li>
<p><strong>Accessibility only works in one direction.</strong> The "leaf" cluster allows
   users from "root" to access its nodes but users in the "leaf" cluster can not
   access the "root" cluster.</p>
</li>
<li>
<p>When a user tries to connect to a node inside "leaf" using root's proxy, the
   reverse tunnel from step 1 is used to establish this connection shown as the
   green line above.</p>
</li>
</ol>
<div class="admonition tip">
<p class="admonition-title">Load Balancers</p>
<p>The scheme above also works even if the "root" cluster uses multiple
proxies behind a load balancer (LB) or a DNS entry with multiple values.
This works by "leaf" establishing a tunnel to <em>every</em> proxy in "root". This
requires that an LB uses round-robin or a similar balancing algorithm. Do
not use sticky load balancing algorithms (a.k.a. "session affinity" or "sticky sessions") with
Teleport proxies.</p>
</div>
<h2 id="join-tokens">Join Tokens</h2>
<p>Lets start with the diagram of how connection between two clusters is established:</p>
<p><img alt="Tunnels" src="../img/trusted-clusters/TrustedClusters-Simple.svg" /></p>
<p>The first step in establishing a secure tunnel between two clusters is for the
<em>leaf</em> cluster "leaf" to connect to the <em>root</em> cluster "root". When this
happens for <em>the first time</em>, clusters know nothing about each other, thus a
shared secret needs to exist in order for "root" to accept the connection from
"leaf".</p>
<p>This shared secret is called a "join token". There are two ways to create join
tokens: to statically define them in a configuration file, or to create them on
the fly using <code>tctl</code> tool.</p>
<div class="admonition tip">
<p class="admonition-title">Important</p>
<p>It is important to realize that join tokens are only used to establish the
connection for the first time. The clusters will exchange certificates and
won't be using the token to re-establish the connection in the future.</p>
</div>
<h3 id="static-join-tokens">Static Join Tokens</h3>
<p>To create a static join token, update the configuration file on "root" cluster
to look like this:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># fragment of /etc/teleport.yaml:</span>
<span class="nt">auth_service</span><span class="p">:</span>
  <span class="nt">enabled</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="nt">tokens</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">trusted_cluster:join-token</span>
</code></pre></div>
<p>This token can be used unlimited number of times.</p>
<h3 id="dynamic-join-tokens">Dynamic Join Tokens</h3>
<p>Creating a token dynamically with a CLI tool offers the advantage of applying a
time to live (TTL) interval on it, i.e. it will be impossible to re-use such
token after a specified period of time.</p>
<p>To create a token using the CLI tool, execute this command on the <em>auth server</em>
of cluster "root":</p>
<div class="highlight"><pre><span></span><code># generates a new token to allow an inbound from a trusting cluster:
$ tctl tokens add --type=trusted_cluster --ttl=5m

The cluster invite token: ba4825847f0378bcdfe18113c4998498
This token will expire in 5 minutes

# you can also list the outstanding non-expired tokens:
$ tctl tokens ls

# ... or delete/revoke an invitation:
$ tctl tokens rm ba4825847f0378bcdfe18113c4998498
</code></pre></div>
<p>Users of Teleport will recognize that this is the same way you would add any
node to a cluster.  The token created above can be used multiple times and has
an expiration time of 5 minutes.</p>
<p>Now, the administrator of "leaf" must create the following resource file:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># cluster.yaml</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">trusted_cluster</span>
<span class="nt">version</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v2</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="c1"># the trusted cluster name MUST match the &#39;cluster_name&#39; setting of the</span>
  <span class="c1"># root cluster</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="c1"># this field allows to create tunnels that are disabled, but can be enabled later.</span>
  <span class="nt">enabled</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="c1"># the token expected by the &quot;root&quot; cluster:</span>
  <span class="nt">token</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ba4825847f0378bcdfe18113c4998498</span>
  <span class="c1"># the address in &#39;host:port&#39; form of the reverse tunnel listening port on the</span>
  <span class="c1"># &quot;root&quot; proxy server:</span>
  <span class="nt">tunnel_addr</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">root.example.com:3024</span>
  <span class="c1"># the address in &#39;host:port&#39; form of the web listening port on the</span>
  <span class="c1"># &quot;root&quot; proxy server:</span>
  <span class="nt">web_proxy_addr</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">root.example.com:3080</span>
  <span class="c1"># the role mapping allows to map user roles from one cluster to another</span>
  <span class="c1"># (enterprise editions of Teleport only)</span>
  <span class="nt">role_map</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">remote</span><span class="p">:</span> <span class="s">&quot;admin&quot;</span>    <span class="c1"># users who have &quot;admin&quot; role on &quot;root&quot;</span>
      <span class="nt">local</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;auditor&quot;</span><span class="p p-Indicator">]</span> <span class="c1"># will be assigned &quot;auditor&quot; role when logging into &quot;leaf&quot;</span>
</code></pre></div>
<p>Then, use <code>tctl create</code> to add the file:</p>
<div class="highlight"><pre><span></span><code>$ tctl create cluster.yaml
</code></pre></div>
<p>At this point the users of the "root" cluster should be able to see "leaf" in the list of available clusters.</p>
<div class="admonition warning">
<p class="admonition-title">HTTPS configuration</p>
<p>If the <code>web_proxy_addr</code> endpoint of the root
cluster uses a self-signed or invalid HTTPS certificate, you will get an
error: <em>"the trusted cluster uses misconfigured HTTP/TLS certificate"</em>. For
ease of testing, the Teleport daemon on "leaf" can be started with the
<code>--insecure</code> CLI flag to accept self-signed certificates. Make sure to configure
HTTPS properly and remove the insecure flag for production use.</p>
</div>
<h3 id="security-implications">Security Implications</h3>
<p>Consider the security implications when deciding which token method to use.
Short lived tokens decrease the window for attack but make automation a bit
more complicated.</p>
<h2 id="rbac">RBAC</h2>
<div class="admonition warning">
<p class="admonition-title">Version Warning</p>
<p>The RBAC section is applicable only to Teleport Enterprise. The open source
version does not support SSH roles.</p>
</div>
<p>When a <em>leaf</em> cluster "leaf" from the diagram above establishes trust with
the <em>root</em> cluster "root", it needs a way to configure which users from
"root" should be allowed in and what permissions should they have. Teleport
Enterprise uses <em>role mapping</em> to achieve this.</p>
<p>Consider the following:</p>
<ul>
<li>Both clusters "root" and "leaf" have their own locally defined roles.</li>
<li>Every user in Teleport Enterprise is assigned a role.</li>
<li>When creating a <em>trusted cluster</em> resource, the administrator of "leaf" must
  define how roles from "root" map to roles on "leaf".</li>
<li>To update role map for an existing <em>trusted cluster</em> delete and re-create the <em>trusted cluster</em> with the updated role map</li>
</ul>
<h3 id="example">Example</h3>
<p>Lets make a few assumptions for this example:</p>
<ul>
<li>
<p>The cluster "root" has two roles: <em>user</em> for regular users and <em>admin</em> for
  local administrators.</p>
</li>
<li>
<p>We want administrators from "root" (but not regular users!) to have
  restricted access to "leaf". We want to deny them access to machines
  with "environment=production" label.</p>
</li>
</ul>
<p>First, we need to create a special role for root users on "leaf":</p>
<div class="highlight"><pre><span></span><code><span class="c1"># save this into root-user-role.yaml on the leaf cluster and execute:</span>
<span class="c1"># tctl create root-user-role.yaml</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">role</span>
<span class="nt">version</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v3</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">local-admin</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">allow</span><span class="p">:</span>
    <span class="nt">node_labels</span><span class="p">:</span>
      <span class="s">&#39;*&#39;</span><span class="p p-Indicator">:</span> <span class="s">&#39;*&#39;</span>
  <span class="nt">deny</span><span class="p">:</span>
    <span class="nt">node_labels</span><span class="p">:</span>
      <span class="s">&quot;environment&quot;</span><span class="p p-Indicator">:</span> <span class="s">&quot;production&quot;</span>
</code></pre></div>
<p>Now, we need to establish trust between roles "root:admin" and "leaf:admin". This is
done by creating a trusted cluster <a href="../admin-guide/#resources">resource</a> on "leaf"
which looks like this:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># save this as root-cluster.yaml on the auth server of &quot;leaf&quot; and then execute:</span>
<span class="c1"># tctl create root-cluster.yaml</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">trusted_cluster</span>
<span class="nt">version</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="s">&quot;name-of-root-cluster&quot;</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">enabled</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="nt">role_map</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">remote</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">admin</span>
      <span class="c1"># admin &lt;-&gt; admin works for community edition. Enterprise users</span>
      <span class="c1"># have great control over RBAC.</span>
      <span class="nt">local</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">admin</span><span class="p p-Indicator">]</span>
  <span class="nt">token</span><span class="p">:</span> <span class="s">&quot;join-token-from-root&quot;</span>
  <span class="nt">tunnel_addr</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">root.example.com:3024</span>
  <span class="nt">web_proxy_addr</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">root.example.com:3080</span>
</code></pre></div>
<p>What if we wanted to let <em>any</em> user from "root" to be allowed to connect to
nodes on "leaf"? In this case we can use a wildcard <code>*</code> in the <code>role_map</code> like this:</p>
<div class="highlight"><pre><span></span><code><span class="nt">role_map</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">remote</span><span class="p">:</span> <span class="s">&quot;*&quot;</span>
    <span class="nt">local</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">admin</span><span class="p p-Indicator">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nt">role_map</span><span class="p">:</span>
   <span class="p p-Indicator">-</span> <span class="nt">remote</span><span class="p">:</span> <span class="s">&#39;cluster-*&#39;</span>
     <span class="nt">local</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">clusteradmin</span><span class="p p-Indicator">]</span>
</code></pre></div>
<p>You can even use <a href="https://github.com/google/re2/wiki/Syntax">regular expressions</a> to
map user roles from one cluster to another, you can even capture parts of the remote
role name and use reference it to name the local role:</p>
<div class="highlight"><pre><span></span><code>  <span class="c1"># in this example, remote users with remote role called &#39;remote-one&#39; will be</span>
  <span class="c1"># mapped to a local role called &#39;local-one&#39;, and `remote-two` becomes `local-two`, etc:</span>
  <span class="p p-Indicator">-</span> <span class="nt">remote</span><span class="p">:</span> <span class="s">&quot;^remote-(.*)$&quot;</span>
    <span class="nt">local</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">local-$1</span><span class="p p-Indicator">]</span>
</code></pre></div>
<p><strong>NOTE:</strong> The regexp matching is activated only when the expression starts
with <code>^</code> and ends with <code>$</code></p>
<h3 id="trusted-cluster-ui">Trusted Cluster UI</h3>
<p>For customers using Teleport Enterprise, they can easily configure <em>leaf</em> nodes using the
Teleport Proxy UI.</p>
<p><strong>Creating Trust from the Leaf node to the root node.</strong>
<img alt="Tunnels" src="../img/trusted-clusters/setting-up-trust.png" /></p>
<h2 id="updating-trusted-cluster-role-map">Updating Trusted Cluster Role Map</h2>
<p>In order to update the role map for a trusted cluster, first we will need to remove the cluster by executing:</p>
<div class="highlight"><pre><span></span><code>$ tctl rm tc/root-cluster
</code></pre></div>
<p>Then following updating the role map, we can re-create the cluster by executing:</p>
<div class="highlight"><pre><span></span><code>$ tctl create root-user-updated-role.yaml
</code></pre></div>
<h2 id="using-trusted-clusters">Using Trusted Clusters</h2>
<p>Now an admin from the "root" cluster can see and access the "leaf" cluster:</p>
<div class="highlight"><pre><span></span><code># log into the root cluster:
$ tsh --proxy=root.example.com login admin
</code></pre></div>
<div class="highlight"><pre><span></span><code># see the list of available clusters
$ tsh clusters

Cluster Name   Status
------------   ------
root           online
leaf           online
</code></pre></div>
<div class="highlight"><pre><span></span><code># see the list of machines (nodes) behind the leaf cluster:
$ tsh ls --cluster=leaf

Node Name Node ID            Address        Labels
--------- ------------------ -------------- -----------
db1.leaf  cf7cc5cd-935e-46f1 10.0.5.2:3022  role=db-leader
db2.leaf  3879d133-fe81-3212 10.0.5.3:3022  role=db-follower
</code></pre></div>
<div class="highlight"><pre><span></span><code># SSH into any node in &quot;leaf&quot;:
$ tsh ssh --cluster=leaf user@db1.leaf
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Note</p>
<p>Trusted clusters work only one way. So, in the example above users from "leaf"
cannot see or connect to the nodes in "root".</p>
</div>
<h3 id="disabling-trust">Disabling Trust</h3>
<p>To temporarily disable trust between clusters, i.e. to disconnect the "leaf"
cluster from "root", edit the YAML definition of the trusted cluster resource
and set <code>enabled</code> to "false", then update it:</p>
<div class="highlight"><pre><span></span><code>$ tctl create --force cluster.yaml
</code></pre></div>
<h3 id="remove-leaf-cluster-relationship-from-both-sides">Remove Leaf Cluster relationship from both sides</h3>
<p>Once established, to fully remove a trust relationship between two clusters, do
the following:</p>
<ul>
<li>Remove the relationship from the leaf cluster: <code>tctl rm tc/root.example.com</code> (<code>tc</code> = trusted cluster)</li>
<li>Remove the relationship from the root cluster: <code>tctl rm lc/leaf.example.com</code>.</li>
</ul>
<h3 id="remove-leaf-cluster-relationship-from-the-root">Remove Leaf Cluster relationship from the root</h3>
<p>Remove the relationship from the root cluster: <code>tctl rm rc/leaf.example.com</code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code>leaf.example.com</code> cluster will continue to try and ping the root cluster,
but will not be able to connect. To re-establish the trusted cluster relationship,
the trusted cluster has to be created again from the leaf cluster.</p>
</div>
<h3 id="remove-leaf-cluster-relationship-from-the-leaf">Remove Leaf Cluster relationship from the leaf</h3>
<p>Remove the relationship from the leaf cluster: <code>tctl rm tc/root.example.com</code>.</p>
<h2 id="sharing-kubernetes-groups-between-trusted-clusters">Sharing Kubernetes groups between Trusted Clusters</h2>
<p>Below is an example of how to share a kubernetes group between trusted clusters.</p>
<p>In this example, we have a root trusted cluster with a role <code>root</code> and kubernetes groups:</p>
<p><div class="highlight"><pre><span></span><code><span class="nt">kubernetes_groups</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;system:masters&quot;</span><span class="p p-Indicator">]</span>
</code></pre></div>
SSH logins:</p>
<p><div class="highlight"><pre><span></span><code><span class="nt">logins</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;root&quot;</span><span class="p p-Indicator">]</span>
</code></pre></div>
The leaf cluster can choose to map this <code>root</code> cluster to its own cluster. The <code>admin</code> cluster in the trusted cluster config:</p>
<p><div class="highlight"><pre><span></span><code><span class="nt">role_map</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">remote</span><span class="p">:</span> <span class="s">&quot;root&quot;</span>
    <span class="nt">local</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">admin</span><span class="p p-Indicator">]</span>
</code></pre></div>
The role <code>admin</code> of the leaf cluster can now be set up to use the root cluster role logins and <code>kubernetes_groups</code> using the following variables:</p>
<div class="admonition tip">
<p class="admonition-title">Note</p>
<p>In order to pass logins from a root trusted cluster to a leaf cluster, you must use the variable <code>{% raw %}{{internal.logins}}{% endraw %}</code>.</p>
</div>
<h2 id="how-does-it-work">How does it work?</h2>
<p>At a first glance, Trusted Clusters in combination with RBAC may seem
complicated. However, it is based on certificate-based SSH authentication
which is fairly easy to reason about:</p>
<p>One can think of an SSH certificate as a "permit" issued and time-stamped by a
certificate authority. A certificate contains four important pieces of data:</p>
<ul>
<li>List of allowed UNIX logins a user can use. They are called "principals" in
  the certificate.</li>
<li>Signature of the certificate authority who issued it (the <em>auth</em> server)</li>
<li>Metadata (certificate extensions): additional data protected by the signature
  above. Teleport uses the metadata to store the list of user roles and SSH
  options like "permit-agent-forwarding".</li>
<li>The expiration date.</li>
</ul>
<p>Try executing <code>tsh status</code> right after <code>tsh login</code> to see all these fields in the
client certificate.</p>
<p>When a user from "root" tries to connect to a node inside "leaf", her
certificate is presented to the auth server of "leaf" and it performs the
following checks:</p>
<ul>
<li>Checks that the certificate signature matches one of the trusted clusters.</li>
<li>Tries to find a local role which maps to the list of principals found in the certificate.</li>
<li>Checks if the local role allows the requested identity (UNIX login) to have access.</li>
<li>Checks that the certificate has not expired.</li>
</ul>
<h2 id="troubleshooting">Troubleshooting</h2>
<p>There are three common types of problems Teleport administrators can run into when configuring
trust between two clusters:</p>
<ul>
<li><strong>HTTPS configuration</strong>: when the root cluster uses a self-signed or invalid HTTPS certificate.</li>
<li><strong>Connectivity problems</strong>: when a leaf cluster "leaf" does not show up in
  <code>tsh clusters</code> output on "root".</li>
<li><strong>Access problems</strong>: when users from "root" get "access denied" error messages
  trying to connect to nodes on "leaf".</li>
</ul>
<h3 id="https-configuration">HTTPS configuration</h3>
<p>If the <code>web_proxy_addr</code> endpoint of the root cluster uses a self-signed or invalid HTTPS certificate,
you will get an error: "the trusted cluster uses misconfigured HTTP/TLS certificate". For ease of
testing, the teleport daemon on "leaf" can be started with the <code>--insecure</code> CLI flag to accept
self-signed certificates. Make sure to configure HTTPS properly and remove the insecure flag for production use.</p>
<h3 id="connectivity-problems">Connectivity Problems</h3>
<p>To troubleshoot connectivity problems, enable verbose output for the auth
servers on both clusters. Usually this can be done by adding <code>--debug</code> flag to
<code>teleport start --debug</code>. You can also do this by updating the configuration
file for both auth servers:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># snippet from /etc/teleport.yaml</span>
<span class="nt">teleport</span><span class="p">:</span>
  <span class="nt">log</span><span class="p">:</span>
    <span class="nt">output</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">stderr</span>
    <span class="nt">severity</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">DEBUG</span>
</code></pre></div>
<p>On systemd-based distributions you can watch the log output via:</p>
<div class="highlight"><pre><span></span><code>$ sudo journalctl -fu teleport
</code></pre></div>
<p>Most of the time you will find out that either a join token is
mismatched/expired, or the network addresses for <code>tunnel_addr</code> or
<code>web_proxy_addr</code> cannot be reached due to pre-existing firewall rules or
how your network security groups are configured on AWS.</p>
<h3 id="access-problems">Access Problems</h3>
<p>Troubleshooting access denied messages can be challenging. A Teleport administrator
should check to see the following:</p>
<ul>
<li>Which roles a user is assigned on "root" when they retrieve their SSH
  certificate via <code>tsh login</code>. You can inspect the retrieved certificate with
  <code>tsh status</code> command on the client side.</li>
<li>Which roles a user is assigned on "leaf" when the role mapping takes place.
  The role mapping result is reflected in the Teleport audit log. By default,
  it is stored in <code>/var/lib/teleport/log</code> on a <em>auth</em> server of a cluster.
  Check the audit log messages on both clusters to get answers for the
  questions above.</li>
</ul>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../architecture/proxy/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Teleport Proxy
              </div>
            </div>
          </a>
        
        
          <a href="../features/enhanced-session-recording/" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Enhanced Session Rec.
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Gravitational Inc, 2016-20
          </div>
        
        
          Made with
          <a href="https://squidfunk.github.io/mkdocs-material-insiders/" target="_blank" rel="noopener">
            Material for MkDocs Insiders
          </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.fd16492e.min.js"></script>
      <script src="../assets/javascripts/bundle.d964fd3f.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.0f64ce30.min.js"
          }, typeof search !== "undefined" && search),
          version: {'method': 'mike'}
        })
      </script>
      
        <script src="../js/version-select.js"></script>
      
    
  </body>
</html>